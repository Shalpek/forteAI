version: "3.8"

services:
  n8n:
    image: n8nio/n8n:latest
    container_name: gitlab-ai-code-review-n8n
    restart: unless-stopped
    ports:
      - "5678:5678"
    environment:
      # Basic Authentication (change these in production!)
      - N8N_BASIC_AUTH_ACTIVE=true
      - N8N_BASIC_AUTH_USER=${N8N_BASIC_AUTH_USER:-admin}
      - N8N_BASIC_AUTH_PASSWORD=${N8N_BASIC_AUTH_PASSWORD:-admin}

      # Network configuration
      - N8N_HOST=${N8N_HOST:-localhost}
      - N8N_PORT=5678
      - N8N_PROTOCOL=${N8N_PROTOCOL:-http}

      # Webhook configuration (important for GitLab webhooks)
      - WEBHOOK_URL=${WEBHOOK_URL:-http://localhost:5678}

      # Timezone
      - GENERIC_TIMEZONE=${GENERIC_TIMEZONE:-UTC}

      # Security (recommended for production)
      - N8N_ENCRYPTION_KEY=${N8N_ENCRYPTION_KEY:-}

      # GitLab environment variables (from .env file)
      - GITLAB_PRIVATE_TOKEN=${GITLAB_PRIVATE_TOKEN}
      - GITLAB_URL=${GITLAB_URL:-https://gitlab.com}

      # Google Gemini API (from .env file)
      - GOOGLE_GEMINI_API_KEY=${GOOGLE_GEMINI_API_KEY}

    volumes:
      # Persist n8n data (workflows, credentials, executions)
      - n8n_data:/home/node/.n8n
      # Optional: mount workflows directory for easy access
      - ./workflows:/data/workflows:ro

    env_file:
      - .env

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--quiet",
          "--tries=1",
          "--spider",
          "http://localhost:5678/healthz",
        ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

volumes:
  n8n_data:
    driver: local
# Optional: If you want to use a reverse proxy (nginx/traefik)
# Uncomment and configure as needed
# networks:
#   default:
#     name: gitlab-ai-code-review-network

